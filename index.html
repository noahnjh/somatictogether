<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somatic Together Directory</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml/dist/js-yaml.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ovo&display=swap" rel="stylesheet">

    <style>
/* Prevent flash of raw mustache syntax before Vue compiles */
[v-cloak] {
  display: none !important;
}
        
/* --- Header Layout --- */
.brand-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #F0F0F0;
  z-index: 1000;
  padding: 0.75rem 1.5rem 0.5rem 1.5rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem; /* optional: adds a small buffer between elements */
}

/* Centered title text */
.brand-title {
  font-family: 'Ovo', serif;
  font-size: 1.4rem;
  color: #137338;
  font-weight: normal;
  text-align: center;
  margin: 0;
}

/* Make header responsive */
/* --- Mobile Header Adjustments --- */
@media (max-width: 640px) {
  .brand-header a {
    padding: 0.25rem 0.5rem; /* tighter padding */
    font-size: 0.75rem;      /* smaller overall text */
  }
  .brand-header a span {
    font-size: 0.7rem;       /* smaller label text */
  }
  .brand-header a i {
    font-size: 0.7rem;       /* smaller icon size */
  }
  .brand-title {
    font-size: 1rem;         /* smaller header title */
  }
}

/* Prevent background scrolling when modal is open */
body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
    padding-right: 0;
}
        
body {
  margin: 0;
  background-color: #fff;
}

/* Make sure the main content starts below the fixed header */
#app {
  margin-top: var(--header-height, 0);
  background-color: #fff;
}

/* Automatically adjust for header height using CSS variable */
.brand-header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #F0F0F0;
  z-index: 1000;
  padding: 0.75rem 1.5rem 0.5rem 1.5rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

/* Modal overlay should also start below the header */
.fixed.inset-0.z-50 {
  top: var(--header-height, 0);
  background-color: #fff;
}

.green-divider {
  border-top: 3px solid #137338;
  width: calc(100% - 2rem); /* slight padding on sides */
  margin: 0 auto;           /* centers it */
  border-radius: 2px;
}

        .aspect-ratio-16-9 {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            overflow: hidden;     /* crop overflow */
            border-radius: 0.5rem; /* optional rounded corners */
        }

        .aspect-ratio-16-9 img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: transparent;
        }

        .responsive-iframe-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
        }

        .responsive-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
/* --- Directory UI Color Cleanup --- */

/* Search & filter input boxes */
input.input-bordered,
select.select-bordered,
textarea.input-bordered {
  background-color: #ffffff !important;
  color: #000000 !important;
  border-color: #d1d5db !important; /* gray-300 */
}

/* Placeholder text */
input::placeholder,
textarea::placeholder {
  color: #6b7280 !important; /* gray-500 */
}

/* Filter chips / tags */
span.inline-block.bg-gray-200 {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
  transition: background-color 0.2s ease;
}

span.inline-block.bg-gray-200:hover {
  background-color: #f3f4f6 !important; /* gray-100 hover */
}

/* Active tag styling — use brand green */
span.inline-block.bg-blue-500,
.scrollable-tags span.bg-blue-500 {
  background-color: #137338 !important;
  border-color: #137338 !important;
  color: #ffffff !important;
}

/* Buttons for filters/search actions */
button.btn {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
}

button.btn:hover {
  background-color: #f3f4f6 !important;
}
@media (max-width: 640px) {
  .search-container .select,
  .search-container .btn {
    width: 48%;
  }
  .search-container input {
    width: 100%;
  }
}
/* Override active facet tag color (replace blue with green) */
.bg-blue-500 {
  background-color: #137338 !important;
  border-color: #137338 !important;
  color: white !important;
}

.bg-blue-500:hover {
  background-color: #0f5e2d !important; /* darker hover tone */
}
        /* --- Force entire page and empty space below to be white --- */
html, body {
  background-color: #ffffff !important;
}

/* Main app container */
#app {
  background-color: #ffffff !important;
}

/* Remove gray background behind modal overlay when it's closed */
.fixed.inset-0 {
  background-color: #ffffff !important; /* fully opaque white */
}

/* Optional: remove any residual footer or outer wrapper color */
footer, .directory-container, .content-wrapper {
  background-color: #ffffff !important;
}
        @media (max-width: 640px) {
  .brand-link {
    font-size: 1.2rem; /* smaller on mobile */
  }
  .brand-subtext {
    font-size: 0.9rem;
  }
}

    </style>
</head>

    <body class="bg-white">
<header class="brand-header flex items-center justify-between">
  <!-- Left side: Back arrow + HOME (hidden on mobile) -->
<a href="https://www.somatictogether.com/"
   class="flex items-center bg-white border border-[#137338] text-[#137338] hover:bg-[#137338] hover:text-white transition-colors duration-200 rounded-full px-3 py-1 shadow-sm">
  <i class="fas fa-arrow-left text-sm mr-2"></i>
  <span class="font-medium text-sm tracking-wide">Home</span>
</a>

      <!-- Centered title (not a link) -->
  <div class="flex-1 text-center">
    <h1 class="brand-title">SOMATIC TOGETHER DIRECTORY</h1>
  </div>
    
      <!-- Left side: FWD arrow + About (hidden on mobile) -->
<a href="https://www.somatictogether.com/about"
   class="flex items-center bg-white border border-[#137338] text-[#137338] hover:bg-[#137338] hover:text-white transition-colors duration-200 rounded-full px-3 py-1 shadow-sm">
    <span class="font-medium text-sm tracking-wide mr-2">About</span>
    <i class="fas fa-arrow-right text-sm"></i>
</a>


  <!-- Placeholder for right-side spacing to balance layout -->
 <!-- <div class="w-8 sm:w-16"></div> -->
</header>
   <div id="app" class="p-5" v-cloak>
<!-- 🔍 Unified Search Bar (Responsive) -->
<div class="search-container bg-white text-black p-4 rounded shadow-sm mb-6 border border-gray-300">
  <div class="flex flex-col md:flex-row md:items-center md:space-x-4">

    <!-- Keyword Search -->
    <div class="flex flex-1 items-center space-x-2 mb-3 md:mb-0">
      <input
        v-model="keywordSearch"
        type="text"
        placeholder="Search by name, title, or description..."
        class="input input-bordered w-full"
      />
      <button @click="clearKeywordSearch" class="btn btn-ghost">Clear</button>
    </div>

    <!-- Location Search (Wrapped on Mobile) -->
    <div class="flex flex-wrap flex-1 gap-2 items-center">
      <input
        v-model="searchLocation"
        type="text"
        placeholder="Search by city or postal code"
        class="input input-bordered flex-grow min-w-[200px]"
        @keyup.enter="searchByLocation"
      />
      <div class="flex flex-wrap gap-2 w-full sm:w-auto">
        <select v-model="searchRadius" class="select select-bordered w-20">
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="250">250</option>
        </select>
        <select v-model="searchUnits" class="select select-bordered w-20">
          <option value="miles">mi</option>
          <option value="km">km</option>
        </select>
        <button @click="searchByLocation" class="btn btn-primary w-full sm:w-auto">Search</button>
        <button @click="clearLocationSearch" class="btn btn-ghost w-full sm:w-auto">Clear</button>
      </div>
    </div>

  </div>
</div>

<div role="alert" class="alert mb-2 bg-white text-black p-3 rounded shadow-sm border border-0">
  <div v-if="isLoading" class="loading-container">Loading...</div>

  <div class="flex-1">
    <div class="scrollable-tags">

      <!-- Clear Filters -->
      <div class="flex flex-wrap items-center mb-4">
        <button @click="resetFilters" class="btn btn-sm mb-2 mr-3 drop-shadow flex items-center">
          <i class="fa fa-times mr-1" aria-hidden="true"></i> Clear Filters
        </button>

        <!-- Loop through each facet -->
        <div v-for="facetInfo in facetCounts" :key="facetInfo.facetKey" class="relative mr-2 mb-2">
  <!-- Dropdown trigger (icon removed, font set to normal) -->
  <button
    @click="toggleVisibility(facetInfo.facetKey)"
    class="btn btn-sm bg-white border border-gray-300 text-black hover:bg-gray-100 flex items-center drop-shadow font-normal"
  >
    {{ facetInfo.facet }}
    <i
      :class="visibleFacets[facetInfo.facetKey] ? 'fa fa-chevron-up ml-2' : 'fa fa-chevron-down ml-2'"
    ></i>
  </button>

          <!-- Dropdown menu -->
          <div
            v-if="visibleFacets[facetInfo.facetKey]"
            class="absolute z-50 mt-2 bg-white border border-gray-300 shadow-md rounded-lg p-3 max-h-64 overflow-y-auto w-72"
          >
            <div
              v-for="valueInfo in facetInfo.values"
              :key="valueInfo.value"
              class="flex items-center mb-1"
            >
              <input
                type="checkbox"
                :id="facetInfo.facetKey + '-' + valueInfo.value"
                class="checkbox checkbox-sm checkbox-success mr-2"
                :checked="activeFacets[facetInfo.facetKey] && activeFacets[facetInfo.facetKey][valueInfo.value]"
                @change="toggleFacet(facetInfo.facetKey, valueInfo.value)"
              />
              <label
                :for="facetInfo.facetKey + '-' + valueInfo.value"
                class="text-sm text-gray-800 cursor-pointer"
              >
                {{ getOriginalFacetValue(facetInfo.facetKey, valueInfo.value) }} ({{ valueInfo.count }})
              </label>
            </div>
          </div>

          <!-- Selected tags below dropdown -->
          <div v-if="activeFacets[facetInfo.facetKey]" class="flex flex-wrap gap-2 mt-2">
            <span
              v-for="(isActive, value) in activeFacets[facetInfo.facetKey]"
              v-if="isActive"
              :key="value"
              class="flex items-center bg-gray-200 text-gray-800 rounded-full px-3 py-1 text-sm font-medium"
            >
              {{ getOriginalFacetValue(facetInfo.facetKey, value) }}
              <button
                @click="toggleFacet(facetInfo.facetKey, value)"
                class="ml-2 text-gray-500 hover:text-red-600 focus:outline-none"
              >
                ✕
              </button>
            </span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">

  <div
    v-for="item in paginatedItems"
    :key="item.id"
    class="max-w-sm rounded overflow-hidden shadow-lg bg-white border border-gray-200 transition duration-300 hover:-translate-y-1 hover:shadow-2xl cursor-pointer will-change-transform"
    @click="showModal(item)"
  >
    <!-- Image with hover zoom effect -->
<div class="overflow-hidden aspect-ratio-16-9 rounded-t bg-gray-100 flex items-center justify-center">
  <img
    :src="item.image"
    alt="Thumbnail"
    class="object-contain w-full h-full"
  >
</div>
  <div class="px-6 py-4">
<!-- Name + Pronouns -->
<div class="font-bold text-xl mb-1 text-black">
  {{ item.name }}
  <span v-if="item.pronouns && item.pronouns.trim() !== ''" class="text-gray-500 font-normal text-sm">
    ({{ item.pronouns }})
  </span>
</div>
    <!-- Title -->
    <div class="text-gray-700 text-sm mb-2">
      {{ item.title }}
    </div>
    <!-- Location -->
    <p class="text-sm text-gray-700 mb-2 flex items-center">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5s-3 1.343-3 3 1.343 3 3 3z" />
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-7.333 8-13a8 8 0 10-16 0c0 5.667 8 13 8 13z" />
  </svg>
      {{ [item.city, item.state || item['state or province'], item.country].filter(Boolean).join(', ') }}
    </p>
    <!-- Truncated Description -->
    <p class="text-gray-600 text-sm mb-3">
      {{ trimDescription(item.description) }}
    </p>
  </div>
</div>
</div>
    <!-- 🧭 Pagination Controls -->
<div class="flex justify-center items-center space-x-2 mt-6">
  <!-- Prev Button -->
  <button
    @click="currentPage = Math.max(currentPage - 1, 1)"
    :disabled="currentPage === 1"
    class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
  >
    Prev
  </button>

  <!-- Page Numbers -->
  <button
    v-for="page in totalPages"
    :key="page"
    @click="currentPage = page"
    :class="[
      'px-3 py-1 rounded',
      currentPage === page
        ? 'bg-[#137338] text-white'
        : 'bg-gray-200 hover:bg-gray-300'
    ]"
  >
    {{ page }}
  </button>

  <!-- Next Button -->
  <button
    @click="currentPage = Math.min(currentPage + 1, totalPages)"
    :disabled="currentPage === totalPages"
    class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
  >
    Next
  </button>
</div>

<div
  v-if="selectedItem"
  class="fixed inset-0 z-50 bg-white overflow-y-auto"
    v-cloak
>
<!-- Back header -->
<div class="sticky top-0 bg-white border-b border-gray-300 flex items-center p-4">
  <button
    @click="closeModal()"
    class="text-gray-700 hover:text-[#137338] flex items-center space-x-2"
  >
    <i class="fas fa-arrow-left"></i>
    <span class="font-semibold">Back</span>
  </button>
</div>

  <!-- Main content -->
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Top section: image left, details right -->
    <div class="flex flex-col md:flex-row md:space-x-8">
      <!-- Image -->
      <div class="md:w-1/2 w-full mb-6 md:mb-0">
        <img
          :src="selectedItem.image || 'default-thumbnail.jpg'"
          alt="Thumbnail"
          class="w-full h-auto max-h-[600px] object-contain rounded-lg border border-gray-200"
        />
      </div>

      <!-- Main details -->
      <div class="md:w-1/2 w-full text-left">
        <h2 class="text-3xl font-bold mb-2 text-black">
          {{ selectedItem.name }}
          <span
            v-if="selectedItem.pronouns && selectedItem.pronouns.trim() !== ''"
            class="text-gray-600 text-lg font-medium"
          >
            ({{ selectedItem.pronouns }})
          </span>
        </h2>
        <h4 class="text-lg text-gray-700 mb-2">{{ selectedItem.title }}</h4>
        <p class="text-sm text-gray-700 mb-4 flex items-center">
          <i class="fas fa-map-marker-alt text-gray-600 mr-2"></i>
          {{ [selectedItem.city, selectedItem.state || selectedItem['state or province'], selectedItem.country].filter(Boolean).join(', ') }}
        </p>
        <p class="text-gray-800 whitespace-pre-line mb-4">
          {{ selectedItem.description }}
        </p>
      </div>
    </div>

    <!-- Full-width sections -->
    <div class="mt-8 space-y-6 text-left">
        <!-- Stylized divider line -->
    <div class="green-divider my-6"></div>
      <!-- Session Format -->
      <div v-if="selectedItem['session format']">
        <strong class="block mb-1">Session Format:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="format in selectedItem['session format'].split(',').map(f => f.trim()).filter(Boolean)"
            :key="format"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ format }}
          </span>
        </div>
      </div>

      <!-- Area of Support -->
      <div v-if="selectedItem['area of support']">
        <strong class="block mb-1">Area of Support:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="area in selectedItem['area of support'].split(',').map(a => a.trim()).filter(Boolean)"
            :key="area"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ area }}
          </span>
        </div>
      </div>

      <!-- Modality of Care -->
      <div v-if="selectedItem['modality of care']">
        <strong class="block mb-1">Modality of Care:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="modality in selectedItem['modality of care'].split(',').map(m => m.trim()).filter(Boolean)"
            :key="modality"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ modality }}
          </span>
        </div>
      </div>

<!-- Gender -->
<!--<div v-if="selectedItem.gender && selectedItem.gender.trim() !== ''">
  <strong class="block mb-1">Gender:</strong>
  <div class="flex flex-wrap">
    <span
      v-for="gender in selectedItem.gender.split(',').map(g => g.trim()).filter(Boolean)"
      :key="gender"
      class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
    >
      {{ gender }}
    </span>
  </div>
</div>-->
      <!-- Sexuality -->
      <div v-if="selectedItem.sexuality && selectedItem.sexuality.trim() !== ''">
        <strong class="block mb-1">Sexuality:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="sexuality in selectedItem.sexuality.split(',').map(s => s.trim()).filter(Boolean)"
            :key="sexuality"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ sexuality }}
          </span>
        </div>
      </div>

<!-- Language -->
<div v-if="selectedItem.language && selectedItem.language.trim() !== ''">
  <strong class="block mb-1">Language:</strong>
  <div class="flex flex-wrap">
    <span
      v-for="lang in selectedItem.language.split(',').map(l => l.trim()).filter(Boolean)"
      :key="lang"
      class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
    >
      {{ lang }}
    </span>
  </div>
</div>

<!-- Timezone -->
<div v-if="selectedItem.timezone && selectedItem.timezone.trim() !== ''">
  <strong class="block mb-1">Timezone:</strong>
  <div class="flex flex-wrap">
    <span
      v-for="tz in selectedItem.timezone.split(',').map(t => t.trim()).filter(Boolean)"
      :key="tz"
      class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
    >
      {{ tz }}
    </span>
  </div>
</div>        

<!-- Website -->
<div v-if="selectedItem.website">
  <strong>Website:</strong>
  <a
    :href="selectedItem.website"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338] hover:underline ml-2"
  >
    {{ selectedItem.website }}
  </a>
</div>

<!-- Booking -->
<div v-if="selectedItem['booking link']">
  <strong>Booking Link:</strong>
  <a
    :href="selectedItem['booking link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338] hover:underline ml-2"
  >
    {{ selectedItem['booking link'] }}
  </a>
</div>

<!-- Contact -->
<div v-if="selectedItem.email || selectedItem.phone">
  <strong>Contact:</strong>
  <span v-if="selectedItem.email">
    <a
      :href="'mailto:' + selectedItem.email"
      class="text-black hover:text-[#137338] hover:underline ml-2"
    >
      {{ selectedItem.email }}
    </a>
  </span>
  <span v-if="selectedItem.phone" class="ml-4">
    <a
      :href="'tel:' + selectedItem.phone"
      class="text-black hover:text-[#137338] hover:underline"
    >
      {{ selectedItem.phone }}
    </a>
  </span>
</div>

<!-- Social Links -->
<div class="flex flex-wrap items-center gap-3 mt-4">
  <a
    v-if="selectedItem['x (twitter) profile link']"
    :href="selectedItem['x (twitter) profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-x-twitter fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['instagram profile link']"
    :href="selectedItem['instagram profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-instagram fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['tiktok profile link']"
    :href="selectedItem['tiktok profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-tiktok fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['facebook profile link']"
    :href="selectedItem['facebook profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-facebook fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['linkedin profile link']"
    :href="selectedItem['linkedin profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-linkedin fa-lg"></i>
  </a>
</div>
      </div>
    </div>
  </div>
</div>

   <script>
        new Vue({
            el: '#app',
            data: {
                items: [],
                allItems: [], // Store all items to reset filters
                selectedItem: null,
                visibleFacets: {}, // Object to control the visibility of each facet
                activeFacets: {},
                isLoading: true,
                config: {},
                searchLocation: '',
                searchRadius: 50,
                searchUnits: 'miles',
                userCoordinates: null,
                keywordSearch: '',
                currentPage: 1,
                itemsPerPage: 12,
            },
            methods: {
                getOriginalFacetHeader(facetName) {
                  const match = this.config.activeFacets.find(f => f.toLowerCase() === facetName.toLowerCase());
                  return match || facetName;
                    },               
                getOriginalFacetValue(facetName, value) {
                  // Find the original-cased version of the value from allItems
                  for (const item of this.allItems) {
                const values = item[facetName]?.split(',').map(v => v.trim());
                if (values && values.some(v => v.toLowerCase() === value.toLowerCase())) {
                  return values.find(v => v.toLowerCase() === value.toLowerCase()) || value;
                    }
                      }
                  return value; // fallback
                    },
              
showModal(item) {
  this.selectedItem = item;
  document.body.classList.add('modal-open');

  // 🧭 Block background touch scrolling on iOS Safari
  document.addEventListener('touchmove', this.preventScroll, { passive: false });
},

closeModal() {
  this.selectedItem = null;
  document.body.classList.remove('modal-open');

  // 🧭 Restore touch scrolling
  document.removeEventListener('touchmove', this.preventScroll, { passive: false });
},

preventScroll(e) {
  // Only block if touch is not inside the modal content
  const modal = document.querySelector('.fixed.inset-0.z-50');
  if (modal && !modal.contains(e.target)) {
    e.preventDefault();
  }
},
                
                trimDescription(description) {
                    return description.length > this.config.descriptionLength ? description.substr(0, this.config.descriptionLength) + '...' : description;
                },
toggleVisibility(facetName) {
  // Close all other dropdowns first
  Object.keys(this.visibleFacets).forEach(key => {
    if (key !== facetName) {
      this.visibleFacets[key] = false;
    }
  });

  // Toggle the clicked one
  this.$set(this.visibleFacets, facetName, !this.visibleFacets[facetName]);
},

toggleFacet(facetName, value) {
  facetName = facetName.toLowerCase();
  value = value.toLowerCase();

  // Create facet group if missing
  if (!this.activeFacets[facetName]) {
    this.$set(this.activeFacets, facetName, {});
  }

  // Toggle facet on/off
  if (this.activeFacets[facetName][value]) {
    this.$delete(this.activeFacets[facetName], value);
  } else {
    this.$set(this.activeFacets[facetName], value, true);
  }

  // Apply filters after change
  this.applyFilters();

  // 🧹 Auto-reset if no filters remain active
  const hasAnyActive = Object.keys(this.activeFacets).some(facet =>
    Object.keys(this.activeFacets[facet]).some(val => this.activeFacets[facet][val])
  );
  if (!hasAnyActive) {
    this.resetFilters();
  }
},
                parseFacets(facetsString, tagsString) {
                    let facets = facetsString;
                    if (!facets || facets.trim() === '') {
                        facets = tagsString;
                    }
                    return facets ? facets.split(',').map(facet => facet.trim().toLowerCase()).filter(facet => facet !== "") : [];
                },
                getUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    params.forEach((value, key) => {
                        this.setActiveFacetsFromUrl(key.toLowerCase(), value.toLowerCase());
                    });
                    this.applyFilters();
                },
                setActiveFacetsFromUrl(facetName, values) {
                    facetName = facetName.toLowerCase();
                    if (!this.activeFacets[facetName]) {
                        this.$set(this.activeFacets, facetName, {});
                    }
                    values.split(',').forEach(value => {
                        this.$set(this.activeFacets[facetName], value.trim().toLowerCase(), true);
                    });
                    console.log("Active Facets after URL params: ", this.activeFacets); // Debugging log
                },
applyFilters() {
  if (Object.keys(this.activeFacets).length === 0) {
    this.items = this.allItems;
    return;
  }

  this.items = this.allItems.filter(item => {
    // Each facet group must match at least one selected value
    return Object.keys(this.activeFacets).every(facetName => {
      const normalizedFacet = facetName.trim().toLowerCase();
      const itemValue = item[normalizedFacet];
      if (!itemValue) return false; // must have that facet field

      const itemFacetValues = itemValue
        .split(',')
        .map(v => v.trim().toLowerCase())
        .filter(Boolean);

      const activeFacetValues = Object.keys(this.activeFacets[facetName])
        .filter(v => this.activeFacets[facetName][v]);

      // Must include *all selected values* from this facet
      return activeFacetValues.every(selectedValue => itemFacetValues.includes(selectedValue));
    });
  });
},

                resetFilters() {
                    this.activeFacets = {};
                    this.items = this.allItems;
                },
async searchByLocation() {
  if (!this.searchLocation) {
    alert('Please enter a city or postal code.');
    return;
  }

  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(this.searchLocation)}`;
    const response = await fetch(url, { headers: { 'User-Agent': 'HSP-Directory/1.0' } });
    const data = await response.json();

    if (!data || data.length === 0) {
      alert('Location not found. Try a different city or postal code.');
      return;
    }

    const { lat, lon } = data[0];
    this.userCoordinates = { lat: parseFloat(lat), lon: parseFloat(lon) };

    // Now filter the directory items by radius
    this.items = this.allItems.filter(item => {
      if (!item.latitude || !item.longitude) return false;
      const distance = this.calculateDistance(
        this.userCoordinates.lat,
        this.userCoordinates.lon,
        parseFloat(item.latitude),
        parseFloat(item.longitude),
        this.searchUnits
      );
      return distance <= parseFloat(this.searchRadius);
    });

    if (this.items.length === 0) {
      alert('No practitioners found within your selected radius.');
    }

  } catch (err) {
    console.error('Error fetching location:', err);
    alert('Error finding that location. Please try again later.');
  }
},

                clearLocationSearch() {
                     this.searchLocation = '';
                      this.searchRadius = 50;
                      this.searchUnits = 'miles';
                      this.userCoordinates = null;
                      this.items = this.allItems; // resets all cards
                },
                calculateDistance(lat1, lon1, lat2, lon2, units = 'miles') {
                    const R = units === 'km' ? 6371 : 3958.8; // Earth radius in km or miles
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                      const a =
                        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * Math.PI / 180) *
                        Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon / 2) *
                        Math.sin(dLon / 2);
                      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                      return R * c; // Distance
                },
                clearKeywordSearch() {
                  this.keywordSearch = '';
                },

            },
            computed: {
facetCounts() {
  const facetValues = {};

  // Build facet counts
  this.allItems.forEach(item => {
    this.config.activeFacets.forEach(facetName => {
      const lowerFacet = facetName.toLowerCase();
      if (item[lowerFacet]) {
        const values = item[lowerFacet]
          .split(',')
          .map(v => v.trim().toLowerCase())
          .filter(v => v !== "");
        // Hide "white / european" from being a visible filter
        if (lowerFacet === 'ethnicity') {
          // You can add more values here if needed later
          const hiddenEthnicities = ['white / european', 'white european', 'european'];
          values.forEach(value => {
            if (hiddenEthnicities.includes(value)) return;
            if (!facetValues[lowerFacet]) facetValues[lowerFacet] = {};
            facetValues[lowerFacet][value] = (facetValues[lowerFacet][value] || 0) + 1;
          });
        } else {          
        values.forEach(value => {
          if (!facetValues[lowerFacet]) facetValues[lowerFacet] = {};
          facetValues[lowerFacet][value] = (facetValues[lowerFacet][value] || 0) + 1;
        });
       }    
      }
    });
  });

  // Return facets in the same order as YAML
  const result = this.config.activeFacets.map(facetName => {
    const lowerFacet = facetName.toLowerCase();
    const values = facetValues[lowerFacet]
      ? Object.keys(facetValues[lowerFacet]).map(value => ({
          value,
          count: facetValues[lowerFacet][value],
        }))
      : [];

    values.sort((a, b) => b.count - a.count);

    return {
      facet: facetName,           // Keep original case from YAML
      facetKey: lowerFacet,       // Internal reference
      values,
    };
  });

  return result;
},

filteredItems() {
  let filtered = this.items;

  // 🔍 Keyword search filter
  if (this.keywordSearch.trim() !== '') {
    const query = this.keywordSearch.toLowerCase();
    filtered = filtered.filter(item =>
      (item.name && item.name.toLowerCase().includes(query)) ||
      (item.title && item.title.toLowerCase().includes(query)) ||
      (item.description && item.description.toLowerCase().includes(query))
    );
  }
  return filtered;
},
  paginatedItems() {
  const start = (this.currentPage - 1) * this.itemsPerPage;
  const end = start + this.itemsPerPage;
  return this.filteredItems.slice(start, end);
},
totalPages() {
  return Math.ceil(this.filteredItems.length / this.itemsPerPage);
},     
                activeFiltersText() {
                    const filters = [];
                    Object.keys(this.activeFacets).forEach(facetName => {
                        const activeValues = Object.keys(this.activeFacets[facetName]).filter(value => this.activeFacets[facetName][value]);
                        if (activeValues.length > 0) {
                            filters.push(`${facetName}: ${activeValues.join(', ')}`);
                        }
                    });
                    return filters.length > 0 ? `Filters: ${filters.join(' | ')}` : 'No active filters';
                },
                 hasAnySocialLinks() {
    if (!this.selectedItem) return false;
    const socialKeys = [
      'x (twitter) profile link',
      'instagram profile link',
      'tiktok profile link',
      'facebook profile link',
      'linkedin profile link'
    ];
    return socialKeys.some(
      key => this.selectedItem[key] && this.selectedItem[key].trim() !== ''
    );
  }
            },
            watch: {
  filteredItems() {
    this.currentPage = 1;
  }
},
            mounted() {
                this.isLoading = true;
                fetch('config.yaml')
                    .then(response => response.text())
                    .then(yaml => {
                        this.config = jsyaml.load(yaml);
                        fetch(this.config.dataSourceUrl.trim())
                            .then(response => response.text())
                            .then(csvData => {
                                 Papa.parse(csvData, {
                                    header: true,
                                    skipEmptyLines: true,
complete: (results) => {
  // Normalize keys to lowercase
  this.allItems = results.data.map(item => {
    const newItem = {};
    Object.keys(item).forEach(key => {
      newItem[key.toLowerCase()] = item[key];
    });
    // Alias support for “Name (First Last)” → “name”
    newItem.name = newItem['name (first last)'] || newItem.name;
          
      return newItem;
  })
    
  // Only include rows where "Approved" is "yes"
  .filter(item => (item.approved || '').trim().toLowerCase() === 'yes');
                                
  // 🔀 Always randomize the order on each page load
  this.allItems = this.allItems.sort(() => Math.random() - 0.5);

  // Initialize items with the randomized order
  this.items = this.allItems;

  console.log("Items randomized and loaded:", this.items);
  console.log("Example Instagram link: ", this.items[0]['instagram profile link']);
  console.log("Raw CSV keys from first item:", Object.keys(results.data[0]));
  console.log("Raw CSV first item:", results.data[0]);
  this.getUrlParams(); // Apply filters from URL after loading data
  this.isLoading = false;
  // Close dropdowns when clicking outside
document.addEventListener('click', (event) => {
  const app = this.$el;
  if (!app.contains(event.target)) return;
  
  // If the click is NOT inside any open dropdown or button, close all
  const clickedInsideDropdown = event.target.closest('.absolute.z-50');
  const clickedButton = event.target.closest('button.btn-sm');
  if (!clickedInsideDropdown && !clickedButton) {
    Object.keys(this.visibleFacets).forEach(key => {
      this.visibleFacets[key] = false;
    });
  }
});
                                     
}

                                });
                            });
                    });
            }
        });

    </script>
<script>
/* ----- Improved dynamic iframe resizing ----- */
function computeNeededHeight() {
  const doc = document.documentElement;
  let maxHeight = Math.max(
    doc.scrollHeight || 0,
    doc.offsetHeight || 0,
    document.body.scrollHeight || 0,
    document.body.offsetHeight || 0
  );

  // include fixed-position overlays (like open cards)
  const fixedEls = Array.from(document.querySelectorAll('*')).filter(el => {
    const style = getComputedStyle(el);
    return style.position === 'fixed' && el.offsetHeight > 0;
  });

  fixedEls.forEach(el => {
    const rect = el.getBoundingClientRect();
    const elBottomInDoc = rect.top + window.pageYOffset + rect.height;
    if (elBottomInDoc > maxHeight) maxHeight = elBottomInDoc;
  });

  return Math.ceil(maxHeight + 20);
}

let resizeTimer = null;
function sendHeightDebounced() {
  if (resizeTimer) clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const height = computeNeededHeight();
    window.parent.postMessage({ type: 'directoryHeight', height }, '*');
  }, 80);
}

// Listen for explicit resize requests from Squarespace
window.addEventListener('message', (event) => {
  if (!event.data) return;
  if (event.data === 'requestHeight' || event.data.type === 'requestHeight') {
    sendHeightDebounced();
  }
});

// Observe all DOM + layout changes
const mutationObserver = new MutationObserver(() => sendHeightDebounced());
mutationObserver.observe(document.body, { childList: true, subtree: true, attributes: true });

const resizeObserver = new ResizeObserver(() => sendHeightDebounced());
resizeObserver.observe(document.body);

// Send height initially + after slight delay for async data
window.addEventListener('load', sendHeightDebounced);
setTimeout(sendHeightDebounced, 600);
</script>
<footer id="footer" class="text-center py-4 mt-10" style="background-color: #F0F0F0; display: none;">
  <p class="text-gray-700 text-sm">
    Our directory is new and growing. Additional practitioners listings can be found via the directories linked 
    <a href="https://www.somatictogether.com/more-directories" class="text-[#137338] hover:underline">here</a>.
  </p>
</footer>
<script>
  // Set --header-height to match the real header height
  window.addEventListener('load', () => {
    const header = document.querySelector('.brand-header');
    if (header) {
      document.documentElement.style.setProperty('--header-height', header.offsetHeight + 'px');
    }
  });
  // Update on resize, in case layout changes on mobile
  window.addEventListener('resize', () => {
    const header = document.querySelector('.brand-header');
    if (header) {
      document.documentElement.style.setProperty('--header-height', header.offsetHeight + 'px');
    }
  });
</script>
<script>
window.addEventListener('load', () => {
  setTimeout(() => {
    const footer = document.getElementById('footer');
    if (footer) footer.style.display = 'block';
  }, 1000); // delay 1 second
});
</script>
       
</body>

</html>
