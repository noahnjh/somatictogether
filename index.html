<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sheet2web Item Directory</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml/dist/js-yaml.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        .aspect-ratio-16-9 {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            overflow: hidden;     /* crop overflow */
            border-radius: 0.5rem; /* optional rounded corners */
        }

        .aspect-ratio-16-9 img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #fff
        }

        .responsive-iframe-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
        }

        .responsive-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
/* --- Directory UI Color Cleanup --- */

/* Search & filter input boxes */
input.input-bordered,
select.select-bordered,
textarea.input-bordered {
  background-color: #ffffff !important;
  color: #000000 !important;
  border-color: #d1d5db !important; /* gray-300 */
}

/* Placeholder text */
input::placeholder,
textarea::placeholder {
  color: #6b7280 !important; /* gray-500 */
}

/* Filter chips / tags */
span.inline-block.bg-gray-200 {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
  transition: background-color 0.2s ease;
}

span.inline-block.bg-gray-200:hover {
  background-color: #f3f4f6 !important; /* gray-100 hover */
}

/* Active tag styling (the blue ones) */
span.inline-block.bg-blue-500 {
  background-color: #2563eb !important; /* Tailwind blue-600 */
  color: #ffffff !important;
}

/* Buttons for filters/search actions */
button.btn {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
}

button.btn:hover {
  background-color: #f3f4f6 !important;
}
/* --- Remove black outline around filters --- */

/* Remove dark border from the filter container */
.filter-container,
.filters-box,
div.bg-gray-800,
div.bg-gray-900 {
  border: none !important;
  background-color: #ffffff !important;
}

/* Remove the dark focus ring on filter elements */
input:focus,
select:focus,
button:focus {
  outline: none !important;
  box-shadow: 0 0 0 2px #93c5fd !important; /* subtle blue focus ring for accessibility */
}    
    </style>
</head>

    <body class="bg-white">
    <div id="app" class="p-5">
        <!-- ðŸ”Ž Keyword Search Bar -->
<div class="mb-6 flex items-center space-x-2 bg-white text-black p-3 rounded shadow-sm border-gray-300">
  <input
    v-model="keywordSearch"
    type="text"
    placeholder="Search by name, title, or description..."
    class="input input-bordered w-full"
  />
  <button @click="clearKeywordSearch" class="btn btn-ghost">Clear</button>
</div>

<!-- ðŸ” Location Search Bar -->
<div class="mb-6 flex flex-wrap items-center space-x-2 bg-white text-black p-3 rounded shadow-sm border-gray-300">
  <input
    v-model="searchLocation"
    type="text"
    placeholder="Enter your city or zip/postal code"
    class="input input-bordered w-64"
  />

  <select v-model="searchRadius" class="select select-bordered">
    <option value="25">25</option>
    <option value="50">50</option>
    <option value="100">100</option>
    <option value="250">250</option>
  </select>

  <select v-model="searchUnits" class="select select-bordered">
    <option value="miles">Miles</option>
    <option value="km">Kilometers</option>
  </select>

  <button @click="searchByLocation" class="btn btn-primary">Search Nearby</button>
  <button @click="clearLocationSearch" class="btn btn-ghost">Clear</button>
</div>
        <div role="alert" class="alert mb-2 bg-white text-black p-3 rounded shadow-sm border gray-300">
            <div v-if="isLoading" class="loading-container">
                Loading...
            </div>
            <div class="flex-1">
                <div class="scrollable-tags">
                    <div class="flex flex-wrap">
                        <button @click="resetFilters" class="btn btn-sm mb-4 mr-2 drop-shadow"><i
                                class="fa fa-window-close" aria-hidden="true"></i>Filters (<span
                                v-if="activeFiltersText" class="text-gray-700">{{ activeFiltersText
                                }}</span>)</button>
                        <div v-for="facetInfo in facetCounts" :key="facetInfo.facet" class="mr-2">
                            <button @click="toggleVisibility(facetInfo.facet)" class="btn btn-sm drop-shadow">
                                <i class="fas fa-filter"></i>
                                {{ visibleFacets[facetInfo.facet] ? ' ' + facetInfo.facet : ' ' + facetInfo.facet }}
                            </button>
                        </div>
                    </div>
                    <div v-for="facetInfo in facetCounts" :key="facetInfo.facet">
                        <div v-if="visibleFacets[facetInfo.facet]">
                            <h3 class="text-2xl font-bold tracking-tight text-gray-900 m-2">{{ facetInfo.facet }}</h3>
                            <span v-for="valueInfo in facetInfo.values" :key="valueInfo.value"
                                :class="{'bg-blue-500 text-white': activeFacets[facetInfo.facet] && activeFacets[facetInfo.facet][valueInfo.value], 'bg-gray-200 text-gray-700': !(activeFacets[facetInfo.facet] && activeFacets[facetInfo.facet][valueInfo.value])}"
                                class="inline-block rounded-full px-3 py-1 text-sm font-semibold mr-2 mb-2 cursor-pointer"
                                @click="toggleFacet(facetInfo.facet.toLowerCase(), valueInfo.value.toLowerCase())">
                                {{ valueInfo.value }} ({{ valueInfo.count }})
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div v-for="item in filteredItems" :key="item.id" class="max-w-sm rounded overflow-hidden shadow-lg">
                <div class="aspect-ratio-16-9">
                    <img :src="item.image" alt="Thumbnail" class="cursor-pointer" @click="showModal(item)">
                </div>
                <div class="px-6 py-4">
                    <div class="font-bold text-xl mb-2">
                        <a href="#" class="text-blue-700 hover:text-blue-900" @click.prevent="showModal(item)">
                            {{ item.title }}
                        </a>
                    </div>
                    <p>{{ trimDescription(item.description) }}</p>
                    <div class="mt-2">
                        <span
                            class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2"
                            v-for="tag in item.tags ? item.tags.split(',') : []" :key="tag">{{ tag }}</span>
                    </div>
                </div>
            </div>
        </div>
            <div v-if="selectedItem" class="fixed inset-0 bg-gray-200 bg-opacity-75 overflow-y-auto h-full w-full"
                @click.self="selectedItem = null">
                <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
                    <div class="modal-card text-left">
                        <img :src="selectedItem.image" alt="Thumbnail"
                        class="w-full max-h-96 object-contain rounded mb-4">
                            <h2 class="text-2xl font-bold mb-2">{{ selectedItem.name }}</h2>
                            <h4 class="text-lg text-gray-600 mb-4">{{ selectedItem.title }}</h4>
                            <p class="mb-4">{{ selectedItem.description }}</p>
                            <p v-if="selectedItem.website">
                            <strong>Website:</strong>
                                <a :href="selectedItem.website" target="_blank" class="text-blue-600 hover:underline">
                                    {{ selectedItem.website }}
                                </a>
                            </p>
                        <p v-if="selectedItem.booking">
                            <strong>Booking:</strong>
                                <a :href="selectedItem.booking" target="_blank" class="text-blue-600 hover:underline">
                                    {{ selectedItem.booking }}
                                </a>
                         </p>
                    </div>
                        <div class="mt-6 text-center">
                            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                                @click="selectedItem = null">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        new Vue({
            el: '#app',
            data: {
                items: [],
                allItems: [], // Store all items to reset filters
                selectedItem: null,
                visibleFacets: {}, // Object to control the visibility of each facet
                activeFacets: {},
                isLoading: true,
                config: {},
                searchLocation: '',
                searchRadius: 50,
                searchUnits: 'miles',
                userCoordinates: null,
                keywordSearch: '',
            },
            methods: {
                showModal(item) {
                    this.selectedItem = item;
                },
                trimDescription(description) {
                    return description.length > this.config.descriptionLength ? description.substr(0, this.config.descriptionLength) + '...' : description;
                },
                toggleVisibility(facetName) {
                    if (!this.visibleFacets[facetName]) {
                        this.$set(this.visibleFacets, facetName, true);
                    } else {
                        this.visibleFacets[facetName] = !this.visibleFacets[facetName];
                    }
                },
                toggleFacet(facetName, value) {
                    facetName = facetName.toLowerCase();
                    value = value.toLowerCase();
                    if (!this.activeFacets[facetName]) {
                        this.$set(this.activeFacets, facetName, {});
                    }
                    if (this.activeFacets[facetName][value]) {
                        this.$delete(this.activeFacets[facetName], value);
                    } else {
                        this.$set(this.activeFacets[facetName], value, true);
                    }
                    this.applyFilters();
                },
                parseFacets(facetsString, tagsString) {
                    let facets = facetsString;
                    if (!facets || facets.trim() === '') {
                        facets = tagsString;
                    }
                    return facets ? facets.split(',').map(facet => facet.trim().toLowerCase()).filter(facet => facet !== "") : [];
                },
                getUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    params.forEach((value, key) => {
                        this.setActiveFacetsFromUrl(key.toLowerCase(), value.toLowerCase());
                    });
                    this.applyFilters();
                },
                setActiveFacetsFromUrl(facetName, values) {
                    facetName = facetName.toLowerCase();
                    if (!this.activeFacets[facetName]) {
                        this.$set(this.activeFacets, facetName, {});
                    }
                    values.split(',').forEach(value => {
                        this.$set(this.activeFacets[facetName], value.trim().toLowerCase(), true);
                    });
                    console.log("Active Facets after URL params: ", this.activeFacets); // Debugging log
                },
                applyFilters() {
                    if (Object.keys(this.activeFacets).length === 0) {
                        this.items = this.allItems;
                        return;
                    }
                    this.items = this.allItems.filter(item => {
                        return Object.keys(this.activeFacets).some(facetName => {
                            if (!item[facetName]) return false;
                            const itemFacetValues = item[facetName] ? item[facetName].split(',').map(value => value.trim().toLowerCase()) : [];
                            const activeFacetValues = this.activeFacets[facetName];
                            return itemFacetValues.some(value => activeFacetValues && activeFacetValues[value]);
                        });
                    });
                },
                resetFilters() {
                    this.activeFacets = {};
                    this.items = this.allItems;
                },
async searchByLocation() {
  if (!this.searchLocation) {
    alert('Please enter a city or postal code.');
    return;
  }

  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(this.searchLocation)}`;
    const response = await fetch(url, { headers: { 'User-Agent': 'HSP-Directory/1.0' } });
    const data = await response.json();

    if (!data || data.length === 0) {
      alert('Location not found. Try a different city or postal code.');
      return;
    }

    const { lat, lon } = data[0];
    this.userCoordinates = { lat: parseFloat(lat), lon: parseFloat(lon) };

    // Now filter the directory items by radius
    this.items = this.allItems.filter(item => {
      if (!item.latitude || !item.longitude) return false;
      const distance = this.calculateDistance(
        this.userCoordinates.lat,
        this.userCoordinates.lon,
        parseFloat(item.latitude),
        parseFloat(item.longitude),
        this.searchUnits
      );
      return distance <= parseFloat(this.searchRadius);
    });

    if (this.items.length === 0) {
      alert('No practitioners found within your selected radius.');
    }

  } catch (err) {
    console.error('Error fetching location:', err);
    alert('Error finding that location. Please try again later.');
  }
},

                clearLocationSearch() {
                     this.searchLocation = '';
                      this.searchRadius = 50;
                      this.searchUnits = 'miles';
                      this.userCoordinates = null;
                },
                calculateDistance(lat1, lon1, lat2, lon2, units = 'miles') {
                    const R = units === 'km' ? 6371 : 3958.8; // Earth radius in km or miles
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                      const a =
                        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * Math.PI / 180) *
                        Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon / 2) *
                        Math.sin(dLon / 2);
                      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                      return R * c; // Distance
                },
                clearKeywordSearch() {
                  this.keywordSearch = '';
                },
            },
            computed: {
                facetCounts() {
                    const facetValues = {};
                    this.allItems.forEach(item => {
                        this.config.activeFacets.forEach(facetName => {
                            const LowerCaseFacetName = facetName.toLowerCase();
                            if (item[LowerCaseFacetName]) {
                                const values = item[LowerCaseFacetName].split(',').map(value => value.trim().toLowerCase()).filter(value => value !== "");
                                values.forEach(value => {
                                    if (!facetValues[LowerCaseFacetName]) {
                                        facetValues[LowerCaseFacetName] = {};
                                    }
                                    if (!facetValues[LowerCaseFacetName][value]) {
                                        facetValues[LowerCaseFacetName][value] = 0;
                                    }
                                    facetValues[LowerCaseFacetName][value]++;
                                });
                            }
                        });
                    });

                    const result = [];
                    Object.keys(facetValues).forEach(facetName => {
                        const facets = Object.keys(facetValues[facetName]).map(value => ({
                            value: value,
                            count: facetValues[facetName][value]
                        }));
                        facets.sort((a, b) => b.count - a.count);
                        result.push({
                            facet: facetName,
                            values: facets
                        });
                    });
                    return result;
                },
filteredItems() {
  let filtered = this.items;

  // ðŸ” Keyword search filter
  if (this.keywordSearch.trim() !== '') {
    const query = this.keywordSearch.toLowerCase();
    filtered = filtered.filter(item =>
      (item.name && item.name.toLowerCase().includes(query)) ||
      (item.title && item.title.toLowerCase().includes(query)) ||
      (item.description && item.description.toLowerCase().includes(query))
    );
  }

  return filtered;
},
                activeFiltersText() {
                    const filters = [];
                    Object.keys(this.activeFacets).forEach(facetName => {
                        const activeValues = Object.keys(this.activeFacets[facetName]).filter(value => this.activeFacets[facetName][value]);
                        if (activeValues.length > 0) {
                            filters.push(`${facetName}: ${activeValues.join(', ')}`);
                        }
                    });
                    return filters.length > 0 ? `Filters: ${filters.join(' | ')}` : 'No active filters';
                }
            },
            mounted() {
                this.isLoading = true;
                fetch('config.yaml')
                    .then(response => response.text())
                    .then(yaml => {
                        this.config = jsyaml.load(yaml);
                        fetch(this.config.dataSourceUrl.trim())
                            .then(response => response.text())
                            .then(csvData => {
                                 Papa.parse(csvData, {
                                    header: true,
                                    skipEmptyLines: true,
                                    complete: (results) => {
                                        this.allItems = results.data.map(item => {
                                            const newItem = {};
                                            Object.keys(item).forEach(key => {
                                                newItem[key.toLowerCase()] = item[key];
                                            });
                                            return newItem;
                                        });
                                        this.items = this.allItems;
                                        console.log("Items loaded: ", this.items); // Debugging log
                                        this.getUrlParams(); // Apply filters from URL after loading data
                                        this.isLoading = false;
                                    }
                                });
                            });
                    });
            }
        });
    </script>
</body>

</html>
