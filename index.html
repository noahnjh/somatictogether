<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somatic Together Directory</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml/dist/js-yaml.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        .aspect-ratio-16-9 {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            overflow: hidden;     /* crop overflow */
            border-radius: 0.5rem; /* optional rounded corners */
        }

        .aspect-ratio-16-9 img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #fff
        }

        .responsive-iframe-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
        }

        .responsive-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
/* --- Directory UI Color Cleanup --- */

/* Search & filter input boxes */
input.input-bordered,
select.select-bordered,
textarea.input-bordered {
  background-color: #ffffff !important;
  color: #000000 !important;
  border-color: #d1d5db !important; /* gray-300 */
}

/* Placeholder text */
input::placeholder,
textarea::placeholder {
  color: #6b7280 !important; /* gray-500 */
}

/* Filter chips / tags */
span.inline-block.bg-gray-200 {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
  transition: background-color 0.2s ease;
}

span.inline-block.bg-gray-200:hover {
  background-color: #f3f4f6 !important; /* gray-100 hover */
}

/* Active tag styling â€” use brand green */
span.inline-block.bg-blue-500,
.scrollable-tags span.bg-blue-500 {
  background-color: #137338 !important;
  border-color: #137338 !important;
  color: #ffffff !important;
}

/* Buttons for filters/search actions */
button.btn {
  background-color: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #d1d5db !important;
}

button.btn:hover {
  background-color: #f3f4f6 !important;
}
@media (max-width: 640px) {
  .search-container .select,
  .search-container .btn {
    width: 48%;
  }
  .search-container input {
    width: 100%;
  }
}
/* Override active facet tag color (replace blue with green) */
.bg-blue-500 {
  background-color: #137338 !important;
  border-color: #137338 !important;
  color: white !important;
}

.bg-blue-500:hover {
  background-color: #0f5e2d !important; /* darker hover tone */
}
        /* --- Force entire page and empty space below to be white --- */
html, body {
  background-color: #ffffff !important;
}

/* Main app container */
#app {
  background-color: #ffffff !important;
}

/* Remove gray background behind modal overlay when it's closed */
.fixed.inset-0 {
  background-color: rgba(255, 255, 255, 0.9) !important;
}

/* Optional: remove any residual footer or outer wrapper color */
footer, .directory-container, .content-wrapper {
  background-color: #ffffff !important;
}
    </style>
</head>

    <body class="bg-white">
    <div id="app" class="p-5">
<!-- ðŸ” Unified Search Bar (Responsive) -->
<div class="search-container bg-white text-black p-4 rounded shadow-sm mb-6 border border-gray-300">
  <div class="flex flex-col md:flex-row md:items-center md:space-x-4">

    <!-- Keyword Search -->
    <div class="flex flex-1 items-center space-x-2 mb-3 md:mb-0">
      <input
        v-model="keywordSearch"
        type="text"
        placeholder="Search by name, title, or description..."
        class="input input-bordered w-full"
      />
      <button @click="clearKeywordSearch" class="btn btn-ghost">Clear</button>
    </div>

    <!-- Location Search (Wrapped on Mobile) -->
    <div class="flex flex-wrap flex-1 gap-2 items-center">
      <input
        v-model="searchLocation"
        type="text"
        placeholder="Enter city or postal code"
        class="input input-bordered flex-grow min-w-[200px]"
      />
      <div class="flex flex-wrap gap-2 w-full sm:w-auto">
        <select v-model="searchRadius" class="select select-bordered w-20">
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="250">250</option>
        </select>
        <select v-model="searchUnits" class="select select-bordered w-20">
          <option value="miles">mi</option>
          <option value="km">km</option>
        </select>
        <button @click="searchByLocation" class="btn btn-primary w-full sm:w-auto">Search</button>
        <button @click="clearLocationSearch" class="btn btn-ghost w-full sm:w-auto">Clear</button>
      </div>
    </div>

  </div>
</div>

        <div role="alert" class="alert mb-2 bg-white text-black p-3 rounded shadow-sm border border-0">
            <div v-if="isLoading" class="loading-container">
                Loading...
            </div>
            <div class="flex-1">
                <div class="scrollable-tags">
<div class="flex flex-wrap">
  <button @click="resetFilters" class="btn btn-sm mb-4 mr-2 drop-shadow">
    <i class="fa fa-times" aria-hidden="true"></i> Clear Filters
  </button>

  <div v-for="facetInfo in facetCounts" :key="facetInfo.facetKey" class="mr-2">
    <button @click="toggleVisibility(facetInfo.facetKey)" class="btn btn-sm drop-shadow">
      <i class="fas fa-filter"></i>
      {{ facetInfo.facet }}
    </button>
  </div>
</div>

<div v-for="facetInfo in facetCounts" :key="'panel-' + facetInfo.facetKey">
  <div v-if="visibleFacets[facetInfo.facetKey]">
    <h3 class="text-2xl font-bold tracking-tight text-gray-900 m-2">{{ facetInfo.facet }}</h3>

    <span
      v-for="valueInfo in facetInfo.values"
      :key="valueInfo.value"
      :class="{
        'bg-blue-500 text-white': activeFacets[facetInfo.facetKey] && activeFacets[facetInfo.facetKey][valueInfo.value],
        'bg-gray-200 text-gray-700': !(activeFacets[facetInfo.facetKey] && activeFacets[facetInfo.facetKey][valueInfo.value])
      }"
      class="inline-block rounded-full px-3 py-1 text-sm font-semibold mr-2 mb-2 cursor-pointer"
      @click="toggleFacet(facetInfo.facetKey, valueInfo.value)"
    >
      {{ getOriginalFacetValue(facetInfo.facetKey, valueInfo.value) }} ({{ valueInfo.count }})
    </span>
  </div>
</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <div
    v-for="item in paginatedItems"
    :key="item.id"
    class="max-w-sm rounded overflow-hidden shadow-lg bg-white border border-gray-200 transition duration-300 hover:-translate-y-1 hover:shadow-2xl cursor-pointer will-change-transform"
    @click="showModal(item)"
  >
    <!-- Image with hover zoom effect -->
<div class="overflow-hidden aspect-ratio-16-9 rounded-t">
  <img
    :src="item.image"
    alt="Thumbnail"
    class="w-full h-auto object-cover"
  >
</div>
  <div class="px-6 py-4">
<!-- Name + Pronouns -->
      <div class="font-bold text-xl mb-1 text-black">
        {{ item.name }}
        <span v-if="item.pronouns && item.pronouns.trim() !== ''"> ({{ item.pronouns }})</span>
      </div>
    <!-- Title -->
    <div class="text-gray-700 text-sm mb-2">
      {{ item.title }}
    </div>
    <!-- Location -->
    <p class="text-sm text-gray-700 mb-2 flex items-center">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5s-3 1.343-3 3 1.343 3 3 3z" />
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-7.333 8-13a8 8 0 10-16 0c0 5.667 8 13 8 13z" />
  </svg>
      {{ [item.city, item.state || item['state or province'], item.country].filter(Boolean).join(', ') }}
    </p>
    <!-- Truncated Description -->
    <p class="text-gray-600 text-sm mb-3">
      {{ trimDescription(item.description) }}
    </p>
  </div>
</div>
</div>
    <!-- ðŸ§­ Pagination Controls -->
<div class="flex justify-center items-center space-x-2 mt-6">
  <!-- Prev Button -->
  <button
    @click="currentPage = Math.max(currentPage - 1, 1)"
    :disabled="currentPage === 1"
    class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
  >
    Prev
  </button>

  <!-- Page Numbers -->
  <button
    v-for="page in totalPages"
    :key="page"
    @click="currentPage = page"
    :class="[
      'px-3 py-1 rounded',
      currentPage === page
        ? 'bg-[#137338] text-white'
        : 'bg-gray-200 hover:bg-gray-300'
    ]"
  >
    {{ page }}
  </button>

  <!-- Next Button -->
  <button
    @click="currentPage = Math.min(currentPage + 1, totalPages)"
    :disabled="currentPage === totalPages"
    class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
  >
    Next
  </button>
</div>

<div
  v-if="selectedItem"
  class="fixed inset-0 z-50 bg-white overflow-y-auto"
>
  <!-- Back header -->
  <div class="sticky top-0 bg-white border-b border-gray-300 flex items-center p-4">
    <button
      @click="selectedItem = null"
      class="text-gray-700 hover:text-[#137338] flex items-center space-x-2"
    >
      <i class="fas fa-arrow-left"></i>
      <span class="font-semibold">Back</span>
    </button>
  </div>

  <!-- Main content -->
  <div class="p-6 max-w-6xl mx-auto">
    <!-- Top section: image left, details right -->
    <div class="flex flex-col md:flex-row md:space-x-8">
      <!-- Image -->
      <div class="md:w-1/2 w-full mb-6 md:mb-0">
        <img
          :src="selectedItem.image || 'default-thumbnail.jpg'"
          alt="Thumbnail"
          class="w-full h-auto max-h-[600px] object-contain rounded-lg border border-gray-200"
        />
      </div>

      <!-- Main details -->
      <div class="md:w-1/2 w-full text-left">
        <h2 class="text-3xl font-bold mb-2 text-black">
          {{ selectedItem.name }}
          <span
            v-if="selectedItem.pronouns && selectedItem.pronouns.trim() !== ''"
            class="text-gray-600 text-lg font-medium"
          >
            ({{ selectedItem.pronouns }})
          </span>
        </h2>
        <h4 class="text-lg text-gray-700 mb-2">{{ selectedItem.title }}</h4>
        <p class="text-sm text-gray-700 mb-4 flex items-center">
          <i class="fas fa-map-marker-alt text-gray-600 mr-2"></i>
          {{ [selectedItem.city, selectedItem.state || selectedItem['state or province'], selectedItem.country].filter(Boolean).join(', ') }}
        </p>
        <p class="text-gray-800 whitespace-pre-line mb-4">
          {{ selectedItem.description }}
        </p>
      </div>
    </div>

    <!-- Full-width sections -->
    <div class="mt-8 space-y-6 text-left">
      <!-- Session Format -->
      <div v-if="selectedItem['session format']">
        <strong class="block mb-1">Session Format:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="format in selectedItem['session format'].split(',').map(f => f.trim()).filter(Boolean)"
            :key="format"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ format }}
          </span>
        </div>
      </div>

      <!-- Area of Support -->
      <div v-if="selectedItem['area of support']">
        <strong class="block mb-1">Area of Support:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="area in selectedItem['area of support'].split(',').map(a => a.trim()).filter(Boolean)"
            :key="area"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ area }}
          </span>
        </div>
      </div>

      <!-- Modality of Care -->
      <div v-if="selectedItem['modality of care']">
        <strong class="block mb-1">Modality of Care:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="modality in selectedItem['modality of care'].split(',').map(m => m.trim()).filter(Boolean)"
            :key="modality"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ modality }}
          </span>
        </div>
      </div>

      <!-- Sexuality -->
      <div v-if="selectedItem.sexuality && selectedItem.sexuality.trim() !== ''">
        <strong class="block mb-1">Sexuality:</strong>
        <div class="flex flex-wrap">
          <span
            v-for="sexuality in selectedItem.sexuality.split(',').map(s => s.trim()).filter(Boolean)"
            :key="sexuality"
            class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm mr-2 mb-2"
          >
            {{ sexuality }}
          </span>
        </div>
      </div>

<!-- Website -->
<div v-if="selectedItem.website">
  <strong>Website:</strong>
  <a
    :href="selectedItem.website"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338] hover:underline ml-2"
  >
    {{ selectedItem.website }}
  </a>
</div>

<!-- Booking -->
<div v-if="selectedItem['booking link']">
  <strong>Booking Link:</strong>
  <a
    :href="selectedItem['booking link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338] hover:underline ml-2"
  >
    {{ selectedItem['booking link'] }}
  </a>
</div>

<!-- Contact -->
<div v-if="selectedItem.email || selectedItem.phone">
  <strong>Contact:</strong>
  <span v-if="selectedItem.email">
    <a
      :href="'mailto:' + selectedItem.email"
      class="text-black hover:text-[#137338] hover:underline ml-2"
    >
      {{ selectedItem.email }}
    </a>
  </span>
  <span v-if="selectedItem.phone" class="ml-4">
    <a
      :href="'tel:' + selectedItem.phone"
      class="text-black hover:text-[#137338] hover:underline"
    >
      {{ selectedItem.phone }}
    </a>
  </span>
</div>

<!-- Social Links -->
<div class="flex flex-wrap items-center gap-3 mt-4">
  <a
    v-if="selectedItem['x (twitter) profile link']"
    :href="selectedItem['x (twitter) profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-x-twitter fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['instagram profile link']"
    :href="selectedItem['instagram profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-instagram fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['tiktok profile link']"
    :href="selectedItem['tiktok profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-tiktok fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['facebook profile link']"
    :href="selectedItem['facebook profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-facebook fa-lg"></i>
  </a>
  <a
    v-if="selectedItem['linkedin profile link']"
    :href="selectedItem['linkedin profile link']"
    target="_blank"
    rel="noopener noreferrer"
    class="text-black hover:text-[#137338]"
  >
    <i class="fab fa-linkedin fa-lg"></i>
  </a>
</div>
      </div>
    </div>
  </div>
</div>

   <script>
new Vue({
  el: '#app',
  data: {
    items: [],
    allItems: [],
    selectedItem: null,
    visibleFacets: {},
    activeFacets: {},
    isLoading: true,
    config: {},
    searchLocation: '',
    searchRadius: 50,
    searchUnits: 'miles',
    userCoordinates: null,
    keywordSearch: '',
    currentPage: 1,
    itemsPerPage: 12,
  },
  methods: {
    showModal(item) {
      this.selectedItem = item;
    },
    trimDescription(description) {
      return description.length > this.config.descriptionLength
        ? description.substr(0, this.config.descriptionLength) + '...'
        : description;
    },
    toggleVisibility(facetName) {
      this.visibleFacets[facetName] = !this.visibleFacets[facetName];
    },
    toggleFacet(facetName, value) {
      facetName = facetName.toLowerCase();
      value = value.toLowerCase();
      if (!this.activeFacets[facetName]) {
        this.$set(this.activeFacets, facetName, {});
      }
      if (this.activeFacets[facetName][value]) {
        this.$delete(this.activeFacets[facetName], value);
      } else {
        this.$set(this.activeFacets[facetName], value, true);
      }
      this.applyFilters();
    },
    applyFilters() {
      if (Object.keys(this.activeFacets).length === 0) {
        this.items = this.allItems;
        return;
      }
      this.items = this.allItems.filter(item => {
        return Object.keys(this.activeFacets).some(facetName => {
          if (!item[facetName]) return false;
          const itemFacetValues = item[facetName]
            ? item[facetName].split(',').map(value => value.trim().toLowerCase())
            : [];
          const activeFacetValues = this.activeFacets[facetName];
          return itemFacetValues.some(value => activeFacetValues && activeFacetValues[value]);
        });
      });
    },
    resetFilters() {
      this.activeFacets = {};
      this.items = this.allItems;
    },

    async searchByLocation() {
      if (!this.searchLocation) {
        alert('Please enter a city or postal code.');
        return;
      }

      try {
        // Fetch from OpenStreetMap (case-insensitive fuzzy query)
        const query = this.searchLocation.trim();
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
        const response = await fetch(url, { headers: { 'User-Agent': 'HSP-Directory/1.0' } });
        const data = await response.json();

        if (!data || data.length === 0) {
          alert('Location not found. Try a different city or postal code.');
          return;
        }

        const { lat, lon } = data[0];
        this.userCoordinates = { lat: parseFloat(lat), lon: parseFloat(lon) };

        // Filter by distance
        this.items = this.allItems.filter(item => {
          if (!item.latitude || !item.longitude) return false;
          const distance = this.calculateDistance(
            this.userCoordinates.lat,
            this.userCoordinates.lon,
            parseFloat(item.latitude),
            parseFloat(item.longitude),
            this.searchUnits
          );
          return distance <= parseFloat(this.searchRadius);
        });

        if (this.items.length === 0) {
          alert('No practitioners found within your selected radius.');
        }
      } catch (err) {
        console.error('Error fetching location:', err);
        alert('Error finding that location. Please try again later.');
      }
    },

    clearLocationSearch() {
      this.searchLocation = '';
      this.searchRadius = 50;
      this.searchUnits = 'miles';
      this.userCoordinates = null;
      // Reset displayed cards to show all items again
      this.items = this.allItems;
    },

    calculateDistance(lat1, lon1, lat2, lon2, units = 'miles') {
      const R = units === 'km' ? 6371 : 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) *
          Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    },

    clearKeywordSearch() {
      this.keywordSearch = '';
    },
  },
  computed: {
    filteredItems() {
      let filtered = this.items;
      if (this.keywordSearch.trim() !== '') {
        const query = this.keywordSearch.toLowerCase();
        filtered = filtered.filter(item =>
          (item.name && item.name.toLowerCase().includes(query)) ||
          (item.title && item.title.toLowerCase().includes(query)) ||
          (item.description && item.description.toLowerCase().includes(query))
        );
      }
      return filtered;
    },
    paginatedItems() {
      const start = (this.currentPage - 1) * this.itemsPerPage;
      const end = start + this.itemsPerPage;
      return this.filteredItems.slice(start, end);
    },
    totalPages() {
      return Math.ceil(this.filteredItems.length / this.itemsPerPage);
    }
  },
  watch: {
    filteredItems() {
      this.currentPage = 1;
    }
  },
  mounted() {
    this.isLoading = true;
    fetch('config.yaml')
      .then(response => response.text())
      .then(yaml => {
        this.config = jsyaml.load(yaml);
        fetch(this.config.dataSourceUrl.trim())
          .then(response => response.text())
          .then(csvData => {
            Papa.parse(csvData, {
              header: true,
              skipEmptyLines: true,
              complete: results => {
                this.allItems = results.data.map(item => {
                  const newItem = {};
                  Object.keys(item).forEach(key => {
                    newItem[key.toLowerCase()] = item[key];
                  });
                  return newItem;
                });
                this.items = this.allItems;
                this.isLoading = false;
              }
            });
          });
      });

    // ðŸ”¹ Allow pressing Enter to trigger search
    window.addEventListener('keydown', e => {
      if (e.key === 'Enter' && this.searchLocation.trim() !== '') {
        this.searchByLocation();
      }
    });
  }
});
</script>

</body>

</html>
